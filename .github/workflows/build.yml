name: Build OpenWrt Multi-Arch Client

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: 'OpenWrt SDK Version'
        required: true
        default: '24.10.5'
      target:
        description: 'Target Architecture'
        required: true
        default: 'x86/64'
        type: choice
        options:
          - 'x86/64'
          - 'mediatek/filogic'
          - 'ramips/mt7621'
          - 'armsr/armv8'

env:
  # 基础配置
  LIBSODIUM_TAG: 1.0.20-RELEASE
  SOURCE_REPO: https://github.com/hrimfaxi/tutuicmptunnel-kmod.git
  SOURCE_DIR: tutuicmptunnel-kmod

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Builder Repo
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev gawk git gettext libssl-dev xsltproc wget unzip python3 zstd bison flex

    - name: Configure Architecture & SDK
      id: config
      run: |
        # 获取输入
        TARGET="${{ inputs.target }}"
        SDK_VER="${{ inputs.sdk_version }}"
        [ -z "$SDK_VER" ] && SDK_VER="24.10.5" # 默认值兜底
        
        echo "Selected Target: $TARGET"
        echo "Selected Version: $SDK_VER"
        
        # === 核心逻辑：根据 Target 设置架构变量 ===
        case "$TARGET" in
          "x86/64")
            ARCH="x86_64"
            KERNEL_ARCH="x86"
            SDK_FILE_PATTERN="openwrt-sdk-*-x86-64_*.tar.zst"
            ;;
          "mediatek/filogic")
            ARCH="aarch64"
            KERNEL_ARCH="arm64"
            SDK_FILE_PATTERN="openwrt-sdk-*-mediatek-filogic_*.tar.zst"
            ;;
          "armsr/armv8")
            ARCH="aarch64"
            KERNEL_ARCH="arm64"
            SDK_FILE_PATTERN="openwrt-sdk-*-armsr-armv8_*.tar.zst"
            ;;
          "ramips/mt7621")
            ARCH="mipsel"
            KERNEL_ARCH="mips"
            SDK_FILE_PATTERN="openwrt-sdk-*-ramips-mt7621_*.tar.zst"
            ;;
          *)
            echo "Error: Unknown target $TARGET"
            exit 1
            ;;
        esac
        
        # 构造 SDK URL
        if [ "$SDK_VER" == "snapshot" ]; then
          SDK_URL="https://downloads.openwrt.org/snapshots/targets/$TARGET/"
        else
          SDK_URL="https://downloads.openwrt.org/releases/$SDK_VER/targets/$TARGET/"
        fi

        # 导出环境变量
        echo "ARCH=$ARCH" >> $GITHUB_ENV
        echo "KERNEL_ARCH=$KERNEL_ARCH" >> $GITHUB_ENV
        echo "SDK_FILE_PATTERN=$SDK_FILE_PATTERN" >> $GITHUB_ENV
        echo "SDK_URL=$SDK_URL" >> $GITHUB_ENV
        
        echo "Configuration set: ARCH=$ARCH, KERNEL=$KERNEL_ARCH"

    - name: Clone Source Code
      run: |
        git clone ${{ env.SOURCE_REPO }} ${{ env.SOURCE_DIR }}

    - name: Download and Setup SDK
      run: |
        mkdir -p $HOME/temp
        cd $HOME/temp
        
        echo "Downloading from: ${{ env.SDK_URL }}"
        wget -r -l1 -np -nd -A "${{ env.SDK_FILE_PATTERN }}" ${{ env.SDK_URL }}
        tar -I zstd -xf openwrt-sdk-*.tar.zst
        
        SDK_HOME=$(find $HOME/temp -maxdepth 1 -type d -name "openwrt-sdk-*")
        echo "SDK_HOME=$SDK_HOME" >> $GITHUB_ENV
        echo "STAGING_DIR=$SDK_HOME/staging_dir" >> $GITHUB_ENV
        
        TOOLCHAIN_DIR=$(ls -d $SDK_HOME/staging_dir/toolchain-*)
        TARGET_DIR=$(ls -d $SDK_HOME/staging_dir/target-*)
        KERNEL_DIR=$(ls -d $SDK_HOME/build_dir/target-*/linux-*/linux-*)
        
        echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
        echo "TARGET_DIR=$TARGET_DIR" >> $GITHUB_ENV
        echo "KERNEL_DIR=$KERNEL_DIR" >> $GITHUB_ENV
        
        echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

    - name: Compile Libsodium (Static & PIC)
      run: |
        cd $HOME/temp
        git clone https://github.com/jedisct1/libsodium.git
        cd libsodium
        git checkout ${{ env.LIBSODIUM_TAG }}
        ./autogen.sh
        
        # 使用动态的 ARCH 变量
        ./configure --host=${{ env.ARCH }}-openwrt-linux \
          --disable-ssp --disable-shared --enable-static --with-pic \
          CC=${{ env.ARCH }}-openwrt-linux-gcc
        
        make -j $(nproc)

    - name: Compile Libmnl
      run: |
        cd $HOME/temp
        git clone https://github.com/justmirror/libmnl
        cd libmnl
        ./autogen.sh
        
        ./configure \
          --host=${{ env.ARCH }}-openwrt-linux \
          --prefix=/usr \
          --exec-prefix=/usr \
          CC=${{ env.ARCH }}-openwrt-linux-gcc \
          CFLAGS="--sysroot=${{ env.TARGET_DIR }} -O2 -pipe" \
          LDFLAGS="--sysroot=${{ env.TARGET_DIR }} -Wl,--gc-sections"

        make clean all
        make DESTDIR=${{ env.TARGET_DIR }} install

    - name: Fix CMake Toolchain File
      run: |
        cd ${{ env.SOURCE_DIR }}
        
        TOOLCHAIN_NAME=$(basename ${{ env.TOOLCHAIN_DIR }})
        TARGET_NAME=$(basename ${{ env.TARGET_DIR }})
        CMAKE_FILE="toolchains/openwrt-${{ env.ARCH }}.cmake"
        
        echo "Patching $CMAKE_FILE..."
        
        # 使用正则替换，适配不同架构文件里的不同写法
        # 1. 替换工具链目录 (toolchain-*)
        sed -i "s|toolchain-[^/]*_musl[^/]*|${TOOLCHAIN_NAME}|g" "$CMAKE_FILE"
        # 2. 替换目标目录 (target-*)
        sed -i "s|target-[^/]*_musl[^/]*|${TARGET_NAME}|g" "$CMAKE_FILE"
        
        cat "$CMAKE_FILE"

    - name: Compile tutuicmptunnel-kmod
      run: |
        cd ${{ env.SOURCE_DIR }}
        rm -f CMakeCache.txt
        mkdir -p build
        
        export PKG_CONFIG_LIBDIR="${{ env.TARGET_DIR }}/usr/lib/pkgconfig"
        export PKG_CONFIG="${{ env.SDK_HOME }}/staging_dir/host/bin/pkg-config"
        
        # 使用动态的 CMAKE_TOOLCHAIN_FILE
        cmake \
          -DCMAKE_TOOLCHAIN_FILE=$(pwd)/toolchains/openwrt-${{ env.ARCH }}.cmake \
          -DBISON_EXECUTABLE=/usr/bin/bison \
          -DCMAKE_BUILD_TYPE=Release \
          -DENABLE_HARDEN_MODE=ON \
          -DSODIUM_INCLUDE_DIR=$HOME/temp/libsodium/src/libsodium/include \
          -DSODIUM_LIBRARY=$HOME/temp/libsodium/src/libsodium/.libs/libsodium.a \
          .
        
        make VERBOSE=1 clean all
        make install DESTDIR=stripped

    - name: Compile Kernel Module
      run: |
        cd ${{ env.SOURCE_DIR }}
        
        # 使用动态的 ARCH 和 KERNEL_ARCH
        make \
          KSRC=${{ env.KERNEL_DIR }} \
          CROSS_COMPILE=${{ env.ARCH }}-openwrt-linux- \
          ARCH=${{ env.KERNEL_ARCH }} \
          -C kmod

    - name: Prepare Artifacts
      run: |
        cd ${{ env.SOURCE_DIR }}
        
        mkdir -p release/bin
        mkdir -p release/modules
        
        cp stripped/usr/local/bin/tuctl* release/bin/
        cp stripped/usr/local/sbin/ktuctl release/bin/
        cp kmod/tutuicmptunnel.ko release/modules/
        
        # 文件名包含架构信息，方便识别
        ARCH_NAME=$(echo "${{ inputs.target }}" | tr '/' '-')
        SDK_VER="${{ inputs.sdk_version }}"
        [ -z "$SDK_VER" ] && SDK_VER="default"
        
        TAR_NAME="tutuicmptunnel-openwrt-${ARCH_NAME}-${SDK_VER}.tar.gz"
        
        cd release
        tar -czvf ../../$TAR_NAME *
        echo "ARTIFACT_NAME=$TAR_NAME" >> $GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: ${{ env.ARTIFACT_NAME }}
